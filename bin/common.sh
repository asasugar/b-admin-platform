#!/bin/bash

# =============================================================================
# B-Admin Platform å…¬å…±è¾…åŠ©å‡½æ•°åº“
# =============================================================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# =============================================================================
# è¿›åº¦æ¡å‡½æ•°
# =============================================================================
print_progress() {
    local step=$1
    local total=$2
    local message=$3
    local percent=$((step * 100 / total))

    # ç®€å•çš„è¿›åº¦æ˜¾ç¤º
    printf "${BLUE}[%s/%s]${NC} ${BOLD}%s${NC} (%d%%)\n" "$step" "$total" "$message" "$percent"
}

# =============================================================================
# æ ‡é¢˜å’Œæ­¥éª¤æ˜¾ç¤ºå‡½æ•°
# =============================================================================

# æ‰“å°ä¸»æ ‡é¢˜
print_title() {
    local title=${1:-"LUCKYSALSEFE BUILD TOOL"}
    echo -e "\n${BOLD}${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${BLUE}â•‘${NC}${BOLD}${WHITE}                       ${title}                ${NC}${BOLD}${BLUE}â•‘${NC}"
    echo -e "${BOLD}${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

# æ‰“å°æ­¥éª¤æ ‡é¢˜
print_step() {
    local step=$1
    local title=$2
    echo -e "\n${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}${WHITE}  STEP $step: $title${NC}"
    echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}


# =============================================================================
# æ¶ˆæ¯è¾“å‡ºå‡½æ•°
# =============================================================================

# æ‰“å°ä¿¡æ¯
print_info() {
    echo -e "${BLUE}â„¹${NC}  $1"
}

# æ‰“å°æˆåŠŸ
print_success() {
    echo -e "${GREEN}âœ…${NC} $1"
}

# æ‰“å°è­¦å‘Š
print_warning() {
    echo -e "${YELLOW}âš ï¸${NC}  $1"
}

# æ‰“å°é”™è¯¯
print_error() {
    echo -e "${RED}âŒ${NC} $1"
}

# æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼ˆä»…åœ¨è°ƒè¯•æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
print_debug() {
    if [[ "${DEBUG:-}" == "true" ]]; then
        echo -e "${PURPLE}ğŸ›${NC} [DEBUG] $1"
    fi
}

# =============================================================================
# ç»“æœå±•ç¤ºå‡½æ•°
# =============================================================================

# æ‰“å°æˆåŠŸç»“æœæ¡†
print_success_box() {
    local title=${1:-"æ“ä½œæˆåŠŸå®Œæˆ!"}
    local env=$2
    local project_name=$3

    echo -e "\n${BOLD}${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${GREEN}                   ğŸ‰ ${title} ğŸ‰                      ${NC}"

    if [[ -n "$env" ]]; then
        echo -e "${BOLD}${GREEN}                        ç¯å¢ƒ: ${env}                          ${NC}"
    fi

    if [[ -n "$project_name" ]]; then
        echo -e "${BOLD}${GREEN}               é¡¹ç›®: ${project_name}         ${NC}"
    fi

    echo -e "${BOLD}${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

# =============================================================================
# ç¯å¢ƒä¿¡æ¯æ˜¾ç¤ºå‡½æ•°
# =============================================================================

# æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
print_env_info() {
    local env=$1
    local project_name=$2
    local project_root=$3
    local node_root=$4
    local log_root=$5
    local app_name=$6

    echo -e "\n${BOLD}${WHITE}ğŸ“‹ ç¯å¢ƒä¿¡æ¯:${NC}"
    # æ ¹æ® app_name æ˜¯å¦å­˜åœ¨æ¥æ˜¾ç¤ºé¡¹ç›®åç§°
    if [ -n "$app_name" ]; then
        echo -e "${CYAN}  é¡¹ç›®åç§°:${NC} ${BOLD}${project_name}/${app_name}${NC}"
    else
        echo -e "${CYAN}  é¡¹ç›®åç§°:${NC} ${BOLD}${project_name}${NC}"
    fi
    echo -e "${CYAN}  é¡¹ç›®æ ¹ç›®å½•:${NC} ${project_root}"
    echo -e "${CYAN}  Nodeæ ¹ç›®å½•:${NC} ${node_root}"
    echo -e "${CYAN}  æ—¥å¿—ç›®å½•:${NC} ${log_root}"
    echo -e "${CYAN}  æœåŠ¡èŠ‚ç‚¹:${NC} ${BOLD}${app_name}"
    echo -e "${CYAN}  æ„å»ºç¯å¢ƒ:${NC} ${BOLD}${YELLOW}${env}${NC}"
    echo -e "${CYAN}  ç”¨æˆ·:${NC} $(whoami)"
    echo -e "${CYAN}  PNPMç‰ˆæœ¬:${NC} $(pnpm -v 2>/dev/null || echo 'æœªå®‰è£…')"
    echo -e "${CYAN}  Nodeç‰ˆæœ¬:${NC} $(node -v 2>/dev/null || echo 'æœªå®‰è£…')"
}

# =============================================================================
# æ—¥å¿—æ˜¾ç¤ºå‡½æ•°
# =============================================================================

# æ˜¾ç¤ºæ—¥å¿—å†…å®¹
print_log() {
    local title=$1
    local log_file=$2
    local color=${3:-$BLUE}

    if [[ -f "$log_file" ]]; then
        echo -e "\n${BOLD}${color}ğŸ“‹ ${title}:${NC}"
        echo -e "${color}$(cat "$log_file")${NC}"
    else
        print_warning "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $log_file"
    fi
}

# =============================================================================
# å·¥å…·å‡½æ•°
# =============================================================================

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•
get_script_dir() {
    echo "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
}

# è·å–é¡¹ç›®æ ¹ç›®å½•
get_project_root() {
    echo "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
}

# å®‰å…¨åœ°è·å– pnpm å­˜å‚¨è·¯å¾„
get_pnpm_store_path() {
    pnpm store path 2>/dev/null
}

# =============================================================================
# è„šæœ¬ä¿¡æ¯
# =============================================================================
print_debug "å…¬å…±è¾…åŠ©å‡½æ•°åº“å·²åŠ è½½"